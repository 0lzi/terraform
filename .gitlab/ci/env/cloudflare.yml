---
cloudflare:
  extends: .tflint
  variables:
    ENV: cloudflare

plan-cloudflare:
  extends:
    - .base
    - .plan_base
  variables:
    ENV: cloudflare
  stage: plan
  script:
    - tofu init -backend-config="lock_method=POST" -backend-config="unlock_method=DELETE"
    - tofu plan -out=$PLAN
    - tofu show -json $PLAN | convert-report > $PLAN_JSON

deploy-cloudflare:
  extends:
    - .base
    - .manual_on_default_branch
  variables:
    ENV: cloudflare
  stage: deploy
  needs:
    - job: plan-cloudflare
      artifacts: true
  script:
    - tofu init -backend-config="lock_method=POST" -backend-config="unlock_method=DELETE"
    - tofu apply $PLAN
